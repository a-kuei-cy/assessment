<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬é©—å¹³å° - ç®¡ç†è€…å¾Œå°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 4px solid #3b82f6; color: #1d4ed8; font-weight: bold; }
        .tab-inactive { color: #6b7280; font-weight: medium; border-bottom: 4px solid transparent; }
        .tab-inactive:hover { color: #3b82f6; border-bottom: 4px solid #bfdbfe; }
        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* æˆªæ–·é•·æ–‡å­— */
        .truncate-2-lines {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen"> <!-- ç§»é™¤é€™è£¡çš„ hidden å’Œ id -->

    <!-- ğŸŒŸ å°‡æ‰€æœ‰å¾Œå°å…§å®¹ç”¨ä¸€å€‹ div åŒ…èµ·ä¾†ï¼Œé è¨­éš±è— (hidden) ğŸŒŸ -->
    <div id="app-content" class="hidden">
        
        <!-- é ‚éƒ¨å°è¦½åˆ— -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-600 p-2 rounded-lg text-white">
                            <i class="ph-bold ph-kanban text-xl"></i>
                        </div>
                        <span class="font-bold text-xl text-gray-800 tracking-wide">æ¸¬é©—ç®¡ç†å¾Œå°</span>
                    </div>
                    <div class="flex items-center space-x-8">
                        <button onclick="switchTab('questions')" id="tab-questions" class="tab-active h-full px-1 flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-database"></i> é¡Œåº«ç®¡ç†
                        </button>
                        <button onclick="switchTab('scores')" id="tab-scores" class="tab-inactive h-full px-1 flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-chart-bar"></i> æˆç¸¾ç´€éŒ„
                        </button>
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 font-medium flex items-center gap-1">
                            <i class="ph-bold ph-sign-out"></i> ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- è¼‰å…¥ä¸­ç•«é¢ -->
        <div id="view-loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <h2 id="loading-text" class="text-xl font-bold text-gray-700 tracking-wider">è¼‰å…¥è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...</h2>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- ================= é¡Œåº«ç®¡ç† Tab ================= -->
            <div id="panel-questions" class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">é¡Œåº«ç®¡ç† (<span id="q-count">0</span>é¡Œ)</h2>
                        <p class="text-gray-500 text-sm mt-1">æ‚¨å¯ä»¥æ–°å¢ã€ç·¨è¼¯æˆ–åˆªé™¤é¡Œç›®ã€‚ç·¨è¼¯å®Œæˆå¾Œè«‹å‹™å¿…é»æ“Šã€Œå„²å­˜åŒæ­¥åˆ°é›²ç«¯ã€ã€‚</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-plus"></i> æ–°å¢é¡Œç›®
                        </button>
                        <button onclick="syncToServer()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-cloud-arrow-up"></i> å„²å­˜åŒæ­¥åˆ°é›²ç«¯
                        </button>
                    </div>
                </div>

                <!-- é¡Œåº«åˆ—è¡¨å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm border-b border-gray-200">
                                    <th class="py-3 px-4 font-bold w-20">å¹´ç´š</th>
                                    <th class="py-3 px-4 font-bold w-1/4">é¡Œç›® (Q)</th>
                                    <th class="py-3 px-4 font-bold w-1/3">é–±è®€æ–‡æœ¬ Snippet</th>
                                    <th class="py-3 px-4 font-bold">å‘åº¦</th>
                                    <th class="py-3 px-4 font-bold text-center w-32">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="q-table-body" class="divide-y divide-gray-100 text-sm">
                                <!-- é¡Œåº«å°‡å‹•æ…‹æ¸²æŸ“æ–¼æ­¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ================= æˆç¸¾ç´€éŒ„ Tab ================= -->
            <div id="panel-scores" class="hidden space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">å­¸ç”Ÿæˆç¸¾ç´€éŒ„ (<span id="s-count">0</span>ç­†)</h2>
                        <p class="text-gray-500 text-sm mt-1">æŸ¥çœ‹æ‰€æœ‰æ¸¬é©—ç´€éŒ„ï¼Œä¸¦å¯åŒ¯å‡ºç‚º Excel/CSV æª”æ¡ˆã€‚</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportScoresCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-download-simple"></i> åŒ¯å‡ºæˆç¸¾ (CSV)
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm border-b border-gray-200">
                                    <th class="py-3 px-4 font-bold">æ¸¬é©—æ™‚é–“</th>
                                    <th class="py-3 px-4 font-bold">å¹´ç´š</th>
                                    <th class="py-3 px-4 font-bold">ç­ç´š</th>
                                    <th class="py-3 px-4 font-bold">å§“å</th>
                                    <th class="py-3 px-4 font-bold text-blue-600">ç¸½åˆ†</th>
                                    <th class="py-3 px-4 font-bold text-gray-500">æ“·å–</th>
                                    <th class="py-3 px-4 font-bold text-gray-500">æ¨è«–</th>
                                    <th class="py-3 px-4 font-bold text-gray-500">è©•é‘‘</th>
                                </tr>
                            </thead>
                            <tbody id="s-table-body" class="divide-y divide-gray-100 text-sm">
                                <!-- æˆç¸¾å°‡å‹•æ…‹æ¸²æŸ“æ–¼æ­¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>

        <!-- ================= ç·¨è¼¯/æ–°å¢é¡Œç›® Modal ================= -->
        <div id="modal-q" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm overflow-y-auto">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="bg-blue-600 px-6 py-4 flex justify-between items-center rounded-t-2xl shrink-0">
                    <h3 id="modal-title" class="text-xl font-bold text-white">æ–°å¢é¡Œç›®</h3>
                    <button onclick="closeModal()" class="text-blue-100 hover:text-white transition-colors">
                        <i class="ph-bold ph-x text-2xl"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto flex-grow space-y-4">
                    <input type="hidden" id="modal-id">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å¹´ç´šçµ„åˆ¥</label>
                            <select id="modal-grade" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="ä¸­å¹´ç´š">ä¸­å¹´ç´š</option>
                                <option value="é«˜å¹´ç´š">é«˜å¹´ç´š</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">èªçŸ¥å‘åº¦</label>
                            <select id="modal-skill" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="æ“·å–ç†è§£">æ“·å–ç†è§£</option>
                                <option value="æ¨è«–çµ±æ•´">æ¨è«–çµ±æ•´</option>
                                <option value="è©•é‘‘åæ€">è©•é‘‘åæ€</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">é–±è®€æ–‡æœ¬ (Text)</label>
                        <textarea id="modal-text" rows="4" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">é¡Œç›® (Question)</label>
                        <input type="text" id="modal-q-text" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 space-y-3">
                        <h4 class="font-bold text-blue-800 text-sm mb-2"><i class="ph-fill ph-warning-circle"></i> æ³¨æ„ï¼šé¸é …1 å¿…é ˆå¡«å¯«ã€Œæ­£ç¢ºç­”æ¡ˆã€ï¼Œç³»çµ±æœƒåœ¨å‡ºé¡Œæ™‚è‡ªå‹•æ‰“äº‚é †åºã€‚</h4>
                        <div>
                            <label class="block text-sm font-bold text-green-700 mb-1">é¸é … 1 (æ­£ç¢ºç­”æ¡ˆ)</label>
                            <input type="text" id="modal-opt1" class="w-full border border-green-300 rounded p-2 focus:ring-green-500 outline-none bg-green-50">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">é¸é … 2 (éŒ¯èª¤ç­”æ¡ˆ)</label>
                            <input type="text" id="modal-opt2" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">é¸é … 3 (éŒ¯èª¤ç­”æ¡ˆ)</label>
                            <input type="text" id="modal-opt3" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">é¸é … 4 (éŒ¯èª¤ç­”æ¡ˆ)</label>
                            <input type="text" id="modal-opt4" class="w-full border border-gray-300 rounded p-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3 shrink-0">
                    <button onclick="closeModal()" class="px-5 py-2 text-gray-600 bg-white border border-gray-300 hover:bg-gray-100 rounded font-bold transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveQuestionToLocal()" class="px-5 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded font-bold flex items-center gap-2 transition-colors">
                        <i class="ph-bold ph-floppy-disk"></i> æš«å­˜é¡Œç›®
                    </button>
                </div>
            </div>
        </div>
    </div> <!-- çµæŸ app-content -->

    <!-- ================= Javascript é‚è¼¯ ================= -->
    <script>
        // ğŸš¨ ã€é‡è¦ã€‘è«‹å°‡ä¸‹æ–¹ç¶²å€æ›¿æ›æˆæ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ ğŸš¨
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4AcuIH43NIY977NG_-w9wTk1o2j5Vif4XuGE7S5UlPnU5mdmVpNqsM7fnoTXTwJCh/exec";
        
        // å¯†ç¢¼è¨­å®š (ç°¡æ˜“é˜²è­·)
        const ADMIN_PASSWORD = "admin123";

        // å…¨åŸŸè³‡æ–™
        let questionsData = [];
        let scoresData = [];
        let isDataDirty = false; // ç´€éŒ„æ˜¯å¦æœ‰ä¿®æ”¹é¡Œåº«ä½†é‚„æ²’åŒæ­¥

        // --- ç™»å…¥é©—è­‰ ---
        window.onload = async () => {
            const { value: password } = await Swal.fire({
                title: 'ç®¡ç†å“¡ç™»å…¥',
                input: 'password',
                inputPlaceholder: 'è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼',
                icon: 'info',
                allowOutsideClick: false,
                allowEscapeKey: false,
                confirmButtonText: 'ç™»å…¥',
                confirmButtonColor: '#3b82f6',
                inputValidator: (value) => {
                    if (!value) return 'å¯†ç¢¼ä¸èƒ½ç‚ºç©ºï¼';
                    if (value !== ADMIN_PASSWORD) return 'å¯†ç¢¼éŒ¯èª¤ï¼';
                }
            });

            if (password === ADMIN_PASSWORD) {
                // å¯†ç¢¼æ­£ç¢ºæ™‚ï¼Œé¡¯ç¤ºå‰›æ‰è¢«éš±è—çš„ app-content å€å¡Š
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('view-loading').classList.remove('hidden'); // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                initData();
            }
        };

        function logout() {
            Swal.fire({
                title: 'ç¢ºå®šè¦ç™»å‡ºï¼Ÿ',
                text: isDataDirty ? 'æ‚¨æœ‰å°šæœªåŒæ­¥çš„é¡Œåº«è®Šæ›´ï¼Œç™»å‡ºå°‡æœƒéºå¤±ï¼' : '',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ç™»å‡º',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) location.reload();
            });
        }

        // --- è¼‰å…¥è³‡æ–™ ---
        async function initData() {
            if (SCRIPT_URL.includes("è«‹å°‡é€™è£¡æ›¿æ›")) {
                Swal.fire({ icon: 'error', title: 'éŒ¯èª¤', text: 'è«‹é–‹ç™¼è€…åœ¨ HTML ä¸­è¨­å®šæ­£ç¢ºçš„ SCRIPT_URLï¼' });
                document.getElementById('view-loading').classList.add('hidden');
                return;
            }

            try {
                // å¹³è¡ŒæŠ“å–é¡Œåº«èˆ‡æˆç¸¾
                const [qRes, sRes] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getQuestions`),
                    fetch(`${SCRIPT_URL}?action=getAllScores`)
                ]);
                
                questionsData = await qRes.json();
                scoresData = await sRes.json();
                
                renderQuestionsTable();
                renderScoresTable();
                
                document.getElementById('view-loading').classList.add('hidden');
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'é€£ç·šå¤±æ•—', text: 'ç„¡æ³•å¾ä¼ºæœå™¨å–å¾—è³‡æ–™ã€‚' });
                document.getElementById('view-loading').classList.add('hidden');
            }
        }

        // --- ä»‹é¢åˆ‡æ› ---
        function switchTab(tab) {
            document.getElementById('panel-questions').classList.add('hidden');
            document.getElementById('panel-scores').classList.add('hidden');
            
            document.getElementById('tab-questions').className = "tab-inactive h-full px-1 flex items-center gap-2 transition-colors";
            document.getElementById('tab-scores').className = "tab-inactive h-full px-1 flex items-center gap-2 transition-colors";

            if (tab === 'questions') {
                document.getElementById('panel-questions').classList.remove('hidden');
                document.getElementById('tab-questions').className = "tab-active h-full px-1 flex items-center gap-2 transition-colors";
            } else {
                document.getElementById('panel-scores').classList.remove('hidden');
                document.getElementById('tab-scores').className = "tab-active h-full px-1 flex items-center gap-2 transition-colors";
            }
        }

        // --- æ¸²æŸ“æˆç¸¾è¡¨æ ¼ ---
        function renderScoresTable() {
            document.getElementById('s-count').innerText = scoresData.length;
            const tbody = document.getElementById('s-table-body');
            tbody.innerHTML = '';
            
            // åè½‰é™£åˆ—è®“æœ€æ–°æˆç¸¾åœ¨æœ€ä¸Šé¢
            const reversedScores = [...scoresData].reverse();
            
            reversedScores.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 px-4 text-gray-500">${s.timestamp}</td>
                    <td class="py-3 px-4"><span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${s.grade}</span></td>
                    <td class="py-3 px-4 font-medium">${s.className}</td>
                    <td class="py-3 px-4 font-medium">${s.name}</td>
                    <td class="py-3 px-4 font-bold text-blue-600">${s.score}</td>
                    <td class="py-3 px-4 text-gray-500">${s.retrieve || 0}</td>
                    <td class="py-3 px-4 text-gray-500">${s.infer || 0}</td>
                    <td class="py-3 px-4 text-gray-500">${s.evaluate || 0}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- æ¸²æŸ“é¡Œåº«è¡¨æ ¼ ---
        function renderQuestionsTable() {
            document.getElementById('q-count').innerText = questionsData.length;
            const tbody = document.getElementById('q-table-body');
            tbody.innerHTML = '';

            questionsData.forEach(q => {
                let badgeColor = q.grade === 'ä¸­å¹´ç´š' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors group";
                tr.innerHTML = `
                    <td class="py-3 px-4"><span class="${badgeColor} px-2 py-1 rounded font-bold text-xs whitespace-nowrap">${q.grade}</span></td>
                    <td class="py-3 px-4 font-medium text-gray-800 truncate-2-lines" title="${q.q}">${q.q}</td>
                    <td class="py-3 px-4 text-gray-500 text-xs truncate-2-lines" title="${q.text}">${q.text}</td>
                    <td class="py-3 px-4 text-gray-600 text-xs">${q.skill}</td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="openModal('${q.id}')" class="text-blue-500 hover:text-blue-700 p-1 mr-1 transition-colors" title="ç·¨è¼¯"><i class="ph-bold ph-pencil-simple text-lg"></i></button>
                        <button onclick="deleteQuestion('${q.id}')" class="text-red-400 hover:text-red-600 p-1 transition-colors" title="åˆªé™¤"><i class="ph-bold ph-trash text-lg"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- æ¨¡æ…‹æ¡†æ“ä½œ (æ–°å¢/ç·¨è¼¯) ---
        function openModal(id = null) {
            const modal = document.getElementById('modal-q');
            modal.classList.remove('hidden');

            if (id) {
                // ç·¨è¼¯æ¨¡å¼
                const q = questionsData.find(item => item.id === id);
                document.getElementById('modal-title').innerText = "ç·¨è¼¯é¡Œç›®";
                document.getElementById('modal-id').value = q.id;
                document.getElementById('modal-grade').value = q.grade;
                document.getElementById('modal-skill').value = q.skill;
                document.getElementById('modal-text').value = q.text;
                document.getElementById('modal-q-text').value = q.q;
                document.getElementById('modal-opt1').value = q.options[0];
                document.getElementById('modal-opt2').value = q.options[1];
                document.getElementById('modal-opt3').value = q.options[2];
                document.getElementById('modal-opt4').value = q.options[3];
            } else {
                // æ–°å¢æ¨¡å¼
                document.getElementById('modal-title').innerText = "æ–°å¢é¡Œç›®";
                document.getElementById('modal-id').value = "";
                document.getElementById('modal-text').value = "";
                document.getElementById('modal-q-text').value = "";
                document.getElementById('modal-opt1').value = "";
                document.getElementById('modal-opt2').value = "";
                document.getElementById('modal-opt3').value = "";
                document.getElementById('modal-opt4').value = "";
            }
        }

        function closeModal() {
            document.getElementById('modal-q').classList.add('hidden');
        }

        // --- å„²å­˜é¡Œç›®è‡³æœ¬åœ°é™£åˆ— ---
        function saveQuestionToLocal() {
            const id = document.getElementById('modal-id').value;
            const grade = document.getElementById('modal-grade').value;
            const skill = document.getElementById('modal-skill').value;
            const text = document.getElementById('modal-text').value.trim();
            const qText = document.getElementById('modal-q-text').value.trim();
            const opt1 = document.getElementById('modal-opt1').value.trim();
            const opt2 = document.getElementById('modal-opt2').value.trim();
            const opt3 = document.getElementById('modal-opt3').value.trim();
            const opt4 = document.getElementById('modal-opt4').value.trim();

            if (!text || !qText || !opt1 || !opt2 || !opt3 || !opt4) {
                Swal.fire({ icon: 'warning', title: 'æ¬„ä½æœªå¡«å¦¥', text: 'è«‹ç¢ºèªæ–‡æœ¬ã€é¡Œç›®èˆ‡æ‰€æœ‰å››å€‹é¸é …çš†å·²å¡«å¯«ï¼' });
                return;
            }

            const newQ = {
                id: id || `CUSTOM_${Date.now()}`, // è‹¥ç‚ºæ–°å¢ï¼Œç”¢ç”Ÿå”¯ä¸€ID
                grade: grade,
                text: text,
                q: qText,
                options: [opt1, opt2, opt3, opt4],
                skill: skill
            };

            if (id) {
                // æ›´æ–°
                const index = questionsData.findIndex(item => item.id === id);
                if (index !== -1) questionsData[index] = newQ;
            } else {
                // æ–°å¢
                questionsData.unshift(newQ); // åŠ åˆ°æœ€å‰é¢æ–¹ä¾¿æŸ¥çœ‹
            }

            isDataDirty = true;
            renderQuestionsTable();
            closeModal();
            
            // æç¤ºéŸ³æˆ–å°å½ˆçª—
            Swal.fire({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                icon: 'success', title: 'å·²æš«å­˜è®Šæ›´ï¼è«‹è¨˜å¾—é»æ“Šã€Œå„²å­˜åŒæ­¥åˆ°é›²ç«¯ã€æ‰æœƒç”Ÿæ•ˆã€‚'
            });
        }

        // --- åˆªé™¤é¡Œç›® ---
        function deleteQuestion(id) {
            Swal.fire({
                title: 'ç¢ºå®šè¦åˆªé™¤æ­¤é¡Œå—ï¼Ÿ',
                text: "æ­¤å‹•ä½œåƒ…æœƒåœ¨æœ¬åœ°åˆªé™¤ï¼Œéœ€é»æ“ŠåŒæ­¥æ‰æœƒçœŸæ­£å¾è³‡æ–™åº«åˆªé™¤ã€‚",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'æ˜¯çš„ï¼Œåˆªé™¤ï¼',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    questionsData = questionsData.filter(item => item.id !== id);
                    isDataDirty = true;
                    renderQuestionsTable();
                }
            });
        }

        // --- åŒæ­¥è‡³ä¼ºæœå™¨ (Google Sheets) ---
        async function syncToServer() {
            if (!isDataDirty) {
                Swal.fire({ icon: 'info', title: 'ç„¡éœ€åŒæ­¥', text: 'ç›®å‰æ²’æœ‰ä»»ä½•è®Šæ›´éœ€è¦å„²å­˜ã€‚' });
                return;
            }

            Swal.fire({
                title: 'åŒæ­¥ä¸­...',
                text: 'æ­£åœ¨å°‡é¡Œåº«è¦†è“‹è‡³ Google è©¦ç®—è¡¨ï¼Œè«‹å‹¿é—œé–‰ç¶²é ã€‚',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const payload = {
                    action: "syncQuestions",
                    questions: questionsData
                };

                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    isDataDirty = false;
                    Swal.fire({ icon: 'success', title: 'åŒæ­¥æˆåŠŸï¼', text: 'é¡Œåº«å·²æˆåŠŸæ›´æ–°è‡³é›²ç«¯ã€‚', confirmButtonColor: '#3b82f6' });
                } else {
                    throw new Error("ä¼ºæœå™¨å›å‚³å¤±æ•—");
                }
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'åŒæ­¥å¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– SCRIPT_URL è¨­å®šã€‚' });
            }
        }

        // --- åŒ¯å‡º CSV æª”æ¡ˆ ---
        function exportScoresCSV() {
            if (scoresData.length === 0) {
                Swal.fire({ icon: 'warning', title: 'æ²’æœ‰è³‡æ–™', text: 'ç›®å‰å°šç„¡å­¸ç”Ÿæˆç¸¾å¯ä¾›åŒ¯å‡ºã€‚' });
                return;
            }

            // æº–å‚™ CSV æ¨™é¡Œ
            let csvContent = "æ¸¬é©—æ™‚é–“,å¹´ç´š,ç­ç´š,å§“å,ç¸½åˆ†,æ“·å–ç†è§£,æ¨è«–çµ±æ•´,è©•é‘‘åæ€\n";
            
            // åŠ å…¥è³‡æ–™åˆ— (è™•ç†å­—ä¸²ä¸­å¯èƒ½æœ‰çš„é€—è™Ÿ)
            scoresData.forEach(s => {
                const row = [
                    `"${s.timestamp}"`,
                    `"${s.grade}"`,
                    `"${s.className}"`,
                    `"${s.name}"`,
                    s.score,
                    s.retrieve || 0,
                    s.infer || 0,
                    s.evaluate || 0
                ];
                csvContent += row.join(",") + "\n";
            });

            // åŠ å…¥ BOM è®“ Excel æ”¯æ´ä¸­æ–‡ UTF-8 é¡¯ç¤º
            const bom = "\uFEFF"; 
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            // æª”ååŠ ä¸Šæ—¥æœŸ
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
            link.setAttribute("download", `é–±è®€æ¸¬é©—æˆç¸¾_${dateStr}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>