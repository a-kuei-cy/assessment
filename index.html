<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–±è®€ç´ é¤Šæ¸¬é©—å¹³å°</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ SweetAlert2 (å–ä»£å‚³çµ± alert) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- å¼•å…¥ Phosphor Icons (åœ–ç¤º) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .option-selected {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        /* éš±è—æ²è»¸ä½†å¯æ»¾å‹• */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">

    <!-- ================= è¼‰å…¥ä¸­ç•«é¢ ================= -->
    <div id="view-loading" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <h2 id="loading-text" class="text-xl font-bold text-gray-700 tracking-wider">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</h2>
    </div>

    <!-- ================= ç™»å…¥é¦–é  ================= -->
    <div id="view-login" class="w-full max-w-md glass-panel rounded-2xl shadow-xl overflow-hidden transition-all duration-500 relative">
        
        <!-- ğŸŒŸ éš±è—ç‰ˆå¾Œå°å…¥å£ (æ”¾åœ¨å³ä¸Šè§’çš„æ·¡æ·¡å°é½’è¼ª) ğŸŒŸ -->
        <a href="admin.html" class="absolute top-4 right-4 text-white opacity-40 hover:opacity-100 transition-opacity z-10 cursor-pointer" title="é€²å…¥ç®¡ç†è€…å¾Œå°">
            <i class="ph-fill ph-gear text-2xl"></i>
        </a>

        <div class="bg-blue-600 p-6 text-center relative">
            <i class="ph-fill ph-book-open-text text-5xl text-white mb-2"></i>
            <h1 class="text-2xl font-bold text-white tracking-wide">é–±è®€ç´ é¤ŠæŒ‘æˆ°è³½</h1>
            <p class="text-blue-100 mt-1 text-sm">é–±è®€ç†è§£ Ã— æ¨è«–çµ±æ•´ Ã— è©•é‘‘åæ€</p>
        </div>
        <div class="p-8">
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è«‹é¸æ“‡å¹´ç´šçµ„åˆ¥</label>
                    <select id="input-grade" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                        <option value="" disabled selected>-- è«‹é¸æ“‡ --</option>
                        <option value="ä¸­å¹´ç´š">ä¸­å¹´ç´š (ä¸‰ã€å››å¹´ç´š)</option>
                        <option value="é«˜å¹´ç´š">é«˜å¹´ç´š (äº”ã€å…­å¹´ç´š)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç­ç´š (ä¾‹å¦‚: ä¸‰ç”²)</label>
                    <input type="text" id="input-class" placeholder="è«‹è¼¸å…¥ç­ç´š" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                    <input type="text" id="input-name" placeholder="è«‹è¼¸å…¥å§“å" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
                <button onclick="startApp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors flex justify-center items-center gap-2 mt-4">
                    <i class="ph-bold ph-play"></i> é–‹å§‹æ¸¬é©—
                </button>
                <button onclick="fetchLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex justify-center items-center gap-2">
                    <i class="ph-bold ph-trophy"></i> æŸ¥çœ‹æ’è¡Œæ¦œ
                </button>
            </div>
        </div>
    </div>

    <!-- ================= æ¸¬é©—ç•«é¢ ================= -->
    <div id="view-quiz" class="hidden w-full max-w-3xl glass-panel rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-2">
                <span id="quiz-user-info" class="bg-white/20 text-white px-3 py-1 rounded-full text-sm font-medium"></span>
            </div>
            <div class="text-white font-bold tracking-wide">
                é€²åº¦ï¼š<span id="quiz-progress" class="text-xl text-yellow-300">1/10</span>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6 overflow-y-auto no-scrollbar flex-grow">
            <!-- æ–‡æœ¬å€å¡Š -->
            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-5 rounded-r-lg mb-6">
                <h3 class="text-sm font-bold text-indigo-600 mb-2 flex items-center gap-1"><i class="ph-bold ph-article"></i> é–±è®€æ–‡æœ¬</h3>
                <p id="quiz-text" class="text-gray-800 leading-relaxed text-lg whitespace-pre-line"></p>
            </div>

            <!-- é¡Œç›®å€å¡Š -->
            <div class="mb-6">
                <h2 id="quiz-question" class="text-xl font-bold text-gray-900 leading-snug"></h2>
                <div class="mt-2 inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded font-medium border border-gray-200">
                    æ¸¬é©—å‘åº¦ï¼š<span id="quiz-skill"></span>
                </div>
            </div>

            <!-- é¸é …å€å¡Š -->
            <div id="quiz-options" class="space-y-3">
                <!-- é¸é …æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-200 shrink-0 bg-gray-50 flex justify-end">
            <button id="btn-next" onclick="nextQuestion()" disabled class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-lg shadow-sm transition-all flex items-center gap-2">
                ä¸‹ä¸€é¡Œ <i class="ph-bold ph-caret-right"></i>
            </button>
        </div>
    </div>

    <!-- ================= æ¸¬é©—çµæœç•«é¢ ================= -->
    <div id="view-result" class="hidden w-full max-w-md glass-panel rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-green-500 p-8 text-center text-white">
            <i class="ph-fill ph-check-circle text-6xl mb-3"></i>
            <h1 class="text-3xl font-bold">æ¸¬é©—å®Œæˆï¼</h1>
            <p class="mt-2 opacity-90">è¾›è‹¦äº†ï¼Œä¾†çœ‹çœ‹ä½ çš„è¡¨ç¾</p>
        </div>
        <div class="p-8 text-center">
            <div class="text-6xl font-black text-blue-600 mb-2" id="result-score">100</div>
            <div class="text-gray-500 font-medium mb-6">ç¸½å¾—åˆ†</div>
            
            <div class="grid grid-cols-3 gap-3 mb-8">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-xs text-blue-600 font-bold mb-1">æ“·å–ç†è§£</div>
                    <div id="score-retrieve" class="text-lg font-bold text-gray-800">0</div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <div class="text-xs text-purple-600 font-bold mb-1">æ¨è«–çµ±æ•´</div>
                    <div id="score-infer" class="text-lg font-bold text-gray-800">0</div>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                    <div class="text-xs text-orange-600 font-bold mb-1">è©•é‘‘åæ€</div>
                    <div id="score-evaluate" class="text-lg font-bold text-gray-800">0</div>
                </div>
            </div>

            <button onclick="fetchLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors flex justify-center items-center gap-2">
                <i class="ph-bold ph-ranking"></i> æŸ¥çœ‹æ’è¡Œæ¦œ
            </button>
        </div>
    </div>

    <!-- ================= æ’è¡Œæ¦œç•«é¢ ================= -->
    <div id="view-leaderboard" class="hidden w-full max-w-lg glass-panel rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-6 text-center shrink-0 relative">
            <button onclick="showView('view-login')" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/80 hover:text-white p-2">
                <i class="ph-bold ph-arrow-left text-2xl"></i>
            </button>
            <i class="ph-fill ph-crown text-4xl text-white mb-1"></i>
            <h1 class="text-2xl font-bold text-white tracking-wide">è‹±é›„æ¦œ</h1>
            <p class="text-yellow-100 mt-1 text-sm">TOP 15 é–±è®€å¤§å¸«</p>
        </div>
        
        <div class="p-0 overflow-y-auto no-scrollbar flex-grow bg-gray-50">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200/50 text-gray-600 text-sm">
                        <th class="py-3 px-4 font-bold text-center w-16">åæ¬¡</th>
                        <th class="py-3 px-4 font-bold">ç­ç´š</th>
                        <th class="py-3 px-4 font-bold">å§“å</th>
                        <th class="py-3 px-4 font-bold text-right">åˆ†æ•¸</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="divide-y divide-gray-100">
                    <!-- æ’è¡Œæ¦œè³‡æ–™å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        <div class="p-4 bg-white border-t shrink-0">
            <button onclick="showView('view-login')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                è¿”å›é¦–é 
            </button>
        </div>
    </div>

    <!-- ================= Javascript é‚è¼¯ ================= -->
    <script>
        // ğŸš¨ ã€é‡è¦ã€‘è«‹å°‡ä¸‹æ–¹å¼•è™Ÿå…§çš„ç¶²å€æ›¿æ›æˆæ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ ğŸš¨
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4AcuIH43NIY977NG_-w9wTk1o2j5Vif4XuGE7S5UlPnU5mdmVpNqsM7fnoTXTwJCh/exec";
        
        // ç³»çµ±è®Šæ•¸
        const QUIZ_COUNT = 10; // æ¯æ¬¡æ¸¬é©—çš„é¡Œæ•¸
        let userInfo = { grade: '', className: '', name: '' };
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedOptionIndex = null;
        let scores = { retrieve: 0, infer: 0, evaluate: 0, totalCorrect: 0 };

        // ç•«é¢åˆ‡æ›æ§åˆ¶
        function showView(viewId) {
            const views = ['view-login', 'view-quiz', 'view-result', 'view-leaderboard'];
            views.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showLoading(text = "è™•ç†ä¸­...") {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('view-loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('view-loading').classList.add('hidden');
        }

        // é™£åˆ—æ´—ç‰Œå‡½æ•¸ (Fisher-Yates)
        function shuffleArray(array) {
            let curId = array.length;
            while (0 !== curId) {
                let randId = Math.floor(Math.random() * curId);
                curId -= 1;
                let tmp = array[curId];
                array[curId] = array[randId];
                array[randId] = tmp;
            }
            return array;
        }

        // 1. é–‹å§‹æŒ‰éˆ•é‚è¼¯
        async function startApp() {
            // é©—è­‰è¼¸å…¥
            userInfo.grade = document.getElementById('input-grade').value;
            userInfo.className = document.getElementById('input-class').value.trim();
            userInfo.name = document.getElementById('input-name').value.trim();

            if (!userInfo.grade || !userInfo.className || !userInfo.name) {
                Swal.fire({ icon: 'warning', title: 'è³‡æ–™æœªå¡«å¯«å®Œæ•´', text: 'è«‹é¸æ“‡å¹´ç´šä¸¦å¡«å¦¥ç­ç´šèˆ‡å§“åï¼', confirmButtonColor: '#3b82f6' });
                return;
            }
            if (SCRIPT_URL.includes("è«‹å°‡é€™è£¡æ›¿æ›")) {
                Swal.fire({ icon: 'error', title: 'å°šæœªè¨­å®šç³»çµ±é€£ç·š', text: 'è«‹é–‹ç™¼è€…åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ­£ç¢ºçš„ SCRIPT_URLï¼', confirmButtonColor: '#ef4444' });
                return;
            }

            showLoading("æ­£åœ¨é©—è­‰èº«åˆ†...");
            
            try {
                // æª¢æŸ¥æ˜¯å¦å·²æ¸¬é©—é
                const checkRes = await fetch(`${SCRIPT_URL}?action=checkRecord&className=${encodeURIComponent(userInfo.className)}&name=${encodeURIComponent(userInfo.name)}`);
                const checkData = await checkRes.json();
                
                if (checkData.exists) {
                    hideLoading();
                    Swal.fire({ icon: 'error', title: 'ç„¡æ³•æ¸¬é©—', text: 'æ‚¨å·²ç¶“åƒåŠ éæœ¬æ¬¡æ¸¬é©—å›‰ï¼', confirmButtonColor: '#3b82f6' });
                    return;
                }

                // ç²å–é¡Œåº«
                showLoading("æ­£åœ¨ç‚ºæ‚¨æŠ½å–é¡Œç›®...");
                const qRes = await fetch(`${SCRIPT_URL}?action=getQuestions`);
                const allQuestions = await qRes.json();
                
                // ç¯©é¸å°æ‡‰å¹´ç´šçš„é¡Œç›®
                let filteredQs = allQuestions.filter(q => q.grade === userInfo.grade);
                
                if (filteredQs.length < QUIZ_COUNT) {
                    hideLoading();
                    Swal.fire({ icon: 'error', title: 'é¡Œåº«ä¸è¶³', text: `è©²å¹´ç´šé¡Œåº«ä¸è¶³ ${QUIZ_COUNT} é¡Œï¼Œè«‹è¯çµ¡è€å¸«ï¼`, confirmButtonColor: '#ef4444' });
                    return;
                }

                // éš¨æ©ŸæŠ½å– 10 é¡Œä¸¦è™•ç†é¸é …æ‰“äº‚
                filteredQs = shuffleArray(filteredQs).slice(0, QUIZ_COUNT);
                
                currentQuestions = filteredQs.map(q => {
                    // å‚™ä»½æ­£ç¢ºè§£ç­”æ–‡å­— (åŸæœ¬å¾Œç«¯å›ºå®šæ”¾åœ¨ index 0)
                    let correctText = q.options[0];
                    // æ‰“äº‚é¸é …
                    let shuffledOptions = shuffleArray([...q.options]);
                    // æ‰¾å‡ºæ‰“äº‚å¾Œæ­£ç¢ºè§£ç­”çš„æ–° index
                    let correctIndex = shuffledOptions.indexOf(correctText);
                    return { ...q, options: shuffledOptions, answerIndex: correctIndex };
                });

                // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
                currentQuestionIndex = 0;
                scores = { retrieve: 0, infer: 0, evaluate: 0, totalCorrect: 0 };
                document.getElementById('quiz-user-info').innerText = `${userInfo.className} ${userInfo.name}`;
                
                hideLoading();
                renderQuestion();
                showView('view-quiz');

            } catch (error) {
                hideLoading();
                Swal.fire({ icon: 'error', title: 'é€£ç·šå¤±æ•—', text: 'ç„¡æ³•é€£ä¸Šä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹æˆ–ç¶²å€è¨­å®šã€‚', confirmButtonColor: '#3b82f6' });
                console.error(error);
            }
        }

        // 2. æ¸²æŸ“å–®ä¸€é¡Œç›®
        function renderQuestion() {
            const q = currentQuestions[currentQuestionIndex];
            selectedOptionIndex = null;
            
            // æ›´æ–°é€²åº¦èˆ‡æ–‡æœ¬
            document.getElementById('quiz-progress').innerText = `${currentQuestionIndex + 1}/${QUIZ_COUNT}`;
            document.getElementById('quiz-text').innerText = q.text;
            document.getElementById('quiz-question').innerText = q.q;
            document.getElementById('quiz-skill').innerText = q.skill;
            
            // è™•ç†æ¨™ç±¤é¡è‰²
            const skillBadge = document.getElementById('quiz-skill');
            skillBadge.className = 'font-bold px-2 rounded ';
            if(q.skill === 'æ“·å–ç†è§£') skillBadge.classList.add('text-blue-600', 'bg-blue-100');
            else if(q.skill === 'æ¨è«–çµ±æ•´') skillBadge.classList.add('text-purple-600', 'bg-purple-100');
            else skillBadge.classList.add('text-orange-600', 'bg-orange-100');

            // æ¸²æŸ“é¸é …
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((optText, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 bg-white hover:border-blue-300 text-gray-700 font-medium text-lg flex items-center gap-3';
                btn.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center text-sm font-bold text-gray-400 option-circle">
                        ${String.fromCharCode(65 + index)}
                    </div>
                    <span>${optText}</span>
                `;
                btn.onclick = () => selectOption(index, btn);
                optionsContainer.appendChild(btn);
            });

            // ç¦ç”¨ä¸‹ä¸€é¡ŒæŒ‰éˆ•
            const btnNext = document.getElementById('btn-next');
            btnNext.disabled = true;
            btnNext.innerHTML = (currentQuestionIndex === QUIZ_COUNT - 1) ? 'å®Œæˆäº¤å· <i class="ph-bold ph-paper-plane-tilt"></i>' : 'ä¸‹ä¸€é¡Œ <i class="ph-bold ph-caret-right"></i>';
        }

        // 3. é¸æ“‡é¸é …
        function selectOption(index, btnElement) {
            selectedOptionIndex = index;
            
            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
            const allBtns = document.querySelectorAll('.option-btn');
            const allCircles = document.querySelectorAll('.option-circle');
            
            allBtns.forEach(btn => {
                btn.classList.remove('option-selected', 'border-blue-500', 'bg-blue-50');
            });
            allCircles.forEach(circle => {
                circle.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                circle.classList.add('border-gray-300', 'text-gray-400');
            });

            // åŠ ä¸Šé¸å–æ¨£å¼
            btnElement.classList.add('option-selected', 'border-blue-500', 'bg-blue-50');
            const circle = btnElement.querySelector('.option-circle');
            circle.classList.remove('border-gray-300', 'text-gray-400');
            circle.classList.add('bg-blue-500', 'text-white', 'border-blue-500');

            // å•Ÿç”¨ä¸‹ä¸€é¡ŒæŒ‰éˆ•
            document.getElementById('btn-next').disabled = false;
        }

        // 4. ä¸‹ä¸€é¡Œæˆ–äº¤å·
        function nextQuestion() {
            const currentQ = currentQuestions[currentQuestionIndex];
            
            // æª¢æŸ¥ç­”æ¡ˆä¸¦è¨˜éŒ„å‘åº¦
            if (selectedOptionIndex === currentQ.answerIndex) {
                scores.totalCorrect++;
                if (currentQ.skill === 'æ“·å–ç†è§£') scores.retrieve++;
                if (currentQ.skill === 'æ¨è«–çµ±æ•´') scores.infer++;
                if (currentQ.skill === 'è©•é‘‘åæ€') scores.evaluate++;
            }

            if (currentQuestionIndex < QUIZ_COUNT - 1) {
                currentQuestionIndex++;
                renderQuestion();
                // è®“å…§å®¹å€å¡Šæ²å‹•å›æœ€ä¸Šæ–¹
                document.querySelector('#view-quiz .overflow-y-auto').scrollTop = 0;
            } else {
                submitResult();
            }
        }

        // 5. é€å‡ºæˆç¸¾
        async function submitResult() {
            showLoading("æ­£åœ¨è¨ˆç®—æˆç¸¾ä¸¦å„²å­˜...");
            
            const finalScore = Math.round((scores.totalCorrect / QUIZ_COUNT) * 100);
            
            const payload = {
                action: "saveScore",
                grade: userInfo.grade,
                className: userInfo.className,
                name: userInfo.name,
                score: finalScore,
                retrieve: scores.retrieve,
                infer: scores.infer,
                evaluate: scores.evaluate
            };

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    // æ›´æ–°çµæœç•«é¢
                    document.getElementById('result-score').innerText = finalScore;
                    document.getElementById('score-retrieve').innerText = scores.retrieve;
                    document.getElementById('score-infer').innerText = scores.infer;
                    document.getElementById('score-evaluate').innerText = scores.evaluate;
                    
                    hideLoading();
                    showView('view-result');
                } else {
                    throw new Error("å„²å­˜å¤±æ•—");
                }
            } catch (error) {
                hideLoading();
                Swal.fire({ icon: 'error', title: 'å„²å­˜å¤±æ•—', text: 'æˆç¸¾ä¸Šå‚³å¤±æ•—ï¼Œè«‹æˆªåœ–æœ¬ç•«é¢ä¸¦é€šçŸ¥è€å¸«ã€‚å¾—åˆ†ï¼š' + finalScore, confirmButtonColor: '#3b82f6' });
            }
        }

        // 6. è®€å–æ’è¡Œæ¦œ
        async function fetchLeaderboard() {
            if (SCRIPT_URL.includes("è«‹å°‡é€™è£¡æ›¿æ›")) {
                Swal.fire({ icon: 'error', title: 'å°šæœªè¨­å®š', text: 'å°šæœªè¨­å®šè³‡æ–™åº«é€£ç·šï¼', confirmButtonColor: '#ef4444' });
                return;
            }

            showLoading("æ­£åœ¨è®€å–è‹±é›„æ¦œ...");
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getRank`);
                const ranks = await res.json();
                
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';
                
                if (ranks.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">ç›®å‰é‚„æ²’æœ‰äººå®Œæˆæ¸¬é©—å–”ï¼å¿«ä¾†ç•¶ç¬¬ä¸€åå§ï¼</td></tr>`;
                } else {
                    ranks.forEach((r, idx) => {
                        let rankIcon = `<span class="inline-block w-6 h-6 rounded-full bg-gray-200 text-gray-600 font-bold leading-6">${idx + 1}</span>`;
                        if(idx === 0) rankIcon = `<i class="ph-fill ph-medal text-2xl text-yellow-500 drop-shadow-sm"></i>`;
                        if(idx === 1) rankIcon = `<i class="ph-fill ph-medal text-2xl text-gray-400 drop-shadow-sm"></i>`;
                        if(idx === 2) rankIcon = `<i class="ph-fill ph-medal text-2xl text-amber-700 drop-shadow-sm"></i>`;

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-yellow-50 transition-colors";
                        tr.innerHTML = `
                            <td class="py-3 px-4 text-center border-b border-gray-100">${rankIcon}</td>
                            <td class="py-3 px-4 border-b border-gray-100 font-medium text-gray-700">${r.className}</td>
                            <td class="py-3 px-4 border-b border-gray-100 font-medium text-gray-800">${r.name}</td>
                            <td class="py-3 px-4 text-right border-b border-gray-100 font-black text-blue-600">${r.score} åˆ†</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                
                hideLoading();
                showView('view-leaderboard');
            } catch (error) {
                hideLoading();
                Swal.fire({ icon: 'error', title: 'è®€å–å¤±æ•—', text: 'ç„¡æ³•å–å¾—æ’è¡Œæ¦œè³‡æ–™', confirmButtonColor: '#3b82f6' });
            }
        }
    </script>
</body>
</html>